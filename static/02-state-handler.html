<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width" />

    <style>
      body { font-family: Tahoma, Geneva, sans-serif; text-align: center; }
    </style>

    <!-- colyseus.js client (npm run bundle-colyseus-client) -->
    <script type="text/javascript" src="colyseus.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/p5.js"></script>

  </head>
  <body>
    <div id="menu">
      <div id="rooms_list"></div>
      <button id="create_room">Create Room</button>
    </div>

    <script>
      var host = window.document.location.host.replace(/:.*/, '');

      var client = new Colyseus.Client(location.protocol.replace("http", "ws") + host + (location.port ? ':' + location.port : ''));

      var getRoomsListInterval = setInterval(function(){
        client.getAvailableRooms('state_handler', function(rooms, err) {
          document.getElementById("rooms_list").innerHTML = "";
          rooms.forEach(room => {
            var roomTag = document.createElement("p");
            roomTag.innerHTML = room.metadata.roomName;
            roomTag.addEventListener("click", ev => {
              joinRoom(room.roomId);
            });

            document.getElementById("rooms_list").appendChild(roomTag);
          });
        })
      }, 1000);

      document.getElementById("create_room").addEventListener("click", ev => {
        joinRoom(null);
      });

      function joinRoom(roomId){
        clearInterval(getRoomsListInterval);

        if(roomId)
          room = client.join(roomId);
        else
          room = client.join("state_handler", {create: true, roomName: "Room" + Math.floor(Math.random() * 10000)});

        initGame();

        room.onJoin.add(function() {
          // listen to patches coming from the server
          room.state.players.onAdd = function(player, sessionId) {
            players[sessionId] = player;
          }

          room.state.players.onRemove = function(player, sessionId) {
            delete players[sessionId];
          }

          room.state.players.onChange = function (player, sessionId) {
            players[sessionId] = player;
          }

          room.state.alpacas.onAdd = function(alpaca, sessionId) {
            alpacas.push(alpaca);
          }

          room.state.decorations.onAdd = function(decoration, sessionId) {
            decorations.push(decoration);
          }
        });

        gameStarted = true;
        canvas.elt.style.display = "inline";
        document.getElementById("menu").style.display = "none";
        loop();
        frameRate(60);
      }

      function initGame(){
        cameraPos = {x: 300, y: 300};

        players = {};
        alpacas = [];
        decorations = [];

        lastMovement = {x: 0, y: 0}

        lastMillis = millis();
      }

      var cameraPos;
      var maxDistCamera = 100;

      var players;
      var alpacas;
      var decorations;

      var keysPressed = {37: false, 38: false, 39: false, 40: false}

      var alpacaImg;
      var alpacaSize = 30;
      var dogImg;
      var dogSize = 50;
      var grassImg;
      var grassSize = 20;

      var lastMovement;

      var lastMillis;

      var canvas;
      var gameStarted = false;
      var room;

      window.addEventListener("keydown", function (e) {
        keysPressed[e.which] = true;
      });

      window.addEventListener("keyup", function (e) {
        keysPressed[e.which] = false;
      });

      function setup() {
        alpacaImg = loadImage('alpaca.png');
        dogImg = loadImage('dog.png');
        grassImg = loadImage('grass.png');

        canvas = createCanvas(600, 600);

        canvas.elt.style.display = "none";
      }

      function draw() {
        if(gameStarted){
          elapsedTime = millis() - lastMillis;
          lastMillis = millis();

          let curPlayer = players[room.sessionId];

          alpacas.forEach(alpaca => {
            if(alpaca.pos && alpaca.velocity){
              alpaca.pos.x += alpaca.velocity.x * elapsedTime;
              alpaca.pos.y += alpaca.velocity.y * elapsedTime;
            }
          });
          Object.keys(players).forEach(sessionId => {
            let player = players[sessionId];
            if(player.pos && player.velocity && sessionId != room.sessionId){
              player.pos.x += player.velocity.x * elapsedTime;
              player.pos.y += player.velocity.y * elapsedTime;
            }
          });

          let direction = createVector(keysPressed[39] - keysPressed[37], keysPressed[40] - keysPressed[38]);
          direction.normalize();
          let movement = {x: direction.x, y: direction.y};

          if(movement.x != lastMovement.x || movement.y != lastMovement.y) {
            room.send({
              type: "set_player_movement",
              payload: movement
            });
          }
          lastMovement = movement;

          if(curPlayer){
            players[room.sessionId].pos.x += movement.x * players[room.sessionId].speed * elapsedTime;
            players[room.sessionId].pos.y += movement.y * players[room.sessionId].speed * elapsedTime;

            cameraPos.x = constrain(cameraPos.x, curPlayer.pos.x - maxDistCamera, curPlayer.pos.x + maxDistCamera);
            cameraPos.y = constrain(cameraPos.y, curPlayer.pos.y - maxDistCamera, curPlayer.pos.y + maxDistCamera);

            room.send({
              type: "check_player_position",
              payload: players[room.sessionId].pos
            });
          }

          render();
        }

        function render() {
          translate(- cameraPos.x + width / 2, - cameraPos.y + height / 2);
          background(90, 190, 40);
          /*
          decorations.forEach(decoration => {
            imageMode(CENTER);
            if(decoration.type == "grass")
              image(grassImg, decoration.pos.x, decoration.pos.y, grassSize, grassSize / grassImg.width * grassImg.height);
          });
          */

          mergeEntitiesArrays([
            {
              type: "Alpaca",
              arr: alpacas.slice()
            }, {
              type: "Player",
              arr: Object.values(players)
            }, {
              type: "Decoration",
              arr: decorations.slice()
            }
          ]).sort(function(entity1, entity2){return entity1.pos.y - entity2.pos.y})
          .forEach(entity => {
            var img;
            var size;
            switch(entity.entityType) {
              case "Alpaca":
                img = alpacaImg;
                size = alpacaSize;
                break;
              case "Player":
                img = dogImg;
                size = dogSize;
                break;
              case "Decoration":
                if(entity.type == "grass")
                  img = grassImg;
                  size = grassSize;
                break;
            }

            imageMode(CENTER);
            image(img, entity.pos.x, entity.pos.y, size, size / img.width * img.height);
          });
        }

        function mergeEntitiesArrays(entitiesArrays){
          var merged = [];
          entitiesArrays.forEach(item => {
            merged = merged.concat(item.arr.map(entity => {
              entity.entityType = item.type;
              return entity;
            }));
          });
          return merged;
        }
      }

    </script>
  </body>
</html>
